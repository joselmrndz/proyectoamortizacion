<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
     <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
<style>
    .enMoney::before {
    content:"$";
    text-align: left;
}
.negMoney {
    color:red;
}

td {
    text-align: right;
}
</style>
</head>
<body>
    <div class="container mt-5">
        <form id="amortizationForm" class="mb-4">
            <div class="form-group">
                <label for="edad">Edad:</label>
                <input type="number" id="edad" class="form-control" placeholder="Ingrese su edad" value="18" required>
            </div>  
             <div class="form-group ui-widget">
                <label for="nacionalidad">País de nacimiento:</label>
                <input type="text" id="nacionalidad" class="form-control" placeholder="Nacionalidad" value="México" required>
               
            </div>
            <div class="form-group ui-widget">
                <label for="ingresosmensuales">Ingresos mensuales:</label>
                <input type="number" id="ingresosmensuales" class="form-control" placeholder="Ingreso mensual neto" value="10000" required>
               
            </div> 
            <div class="form-group">
                <label for="buro">Buro de credito (bueno, regular,malo):</label>
                <input type="text" id="buro" value="bueno" class="form-control" placeholder="bueno, regular,malo" required>
            </div>
            <div class="form-group">
                <label for="scorecrediticio">Score:</label>
                <input type="range" name="score" id="scorecrediticio"  min="400" max="850" value="625" class="form-range" id="customRange1">
                <p id="scorecrediticio2">Score: 625</p>
                <script>
                    $(document).ready(function() {
                        $('#scorecrediticio').on('input', function() {
                            var value = $(this).val();
                            $('#scorecrediticio2').text('Score: ' + value);
                        });
                    });
                </script>
              </div>
            <div class="form-group">
                <label for="principal">Monto del Préstamo:</label>
                <input type="number" id="principal" class="form-control" min="1000" max="1000000000" placeholder="Ingrese el monto del préstamo" value="10000" required>
            </div>
           
            <div class="form-group">
                <label for="mesescredito">Número de Meses:</label>
                <input type="range" name="score" id="mesescredito" step="12"  min="12" max="60" value="12" class="form-range" id="customRange1">
                <p id="mesescredito2">Meses: 12</p>
                <script>
                    $(document).ready(function() {
                        $('#mesescredito').on('input', function() {
                            var value = $(this).val();
                            $('#mesescredito2').text('Meses: ' + value);
                        });
                    });
                </script> </div>
           
          

          
        <div class="form-group">
            <label for="tasareferencia" id="lbltasareferencia">Tasa de Interés Referencia:</label>
            <input type="number" value="10"  id="tasareferencia" class="form-control" placeholder="Ingrese la tasa de interés anual" step="0.0001" required>
        </div>
             <div class="form-group">
                <label for="annualInterestRate">Tasa de Interés Anual (%):</label>
                <input type="number" value="10"  id="annualInterestRate" class="form-control" placeholder="Ingrese la tasa de interés anual" step="0.0001" required>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Actualizar Tabla</button>
        </form>
<div style="overflow:scroll;">
    
         <table id="tablahtml"  class="table table-bordered table-striped mt-4">
            <thead class="thead-dark">
                <tr>
                    <tr>
                        <th colspan="5" style="text-align: center; font-size: large;">Tabla Amortización  </th>
                    </tr>
                    <tr>
                        <th colspan="4" style="text-align: right;">Monto: </th>
                        <th  id="montotabla">100000  </th>
                    </tr>
                    <tr>
                        <th colspan="4" style="text-align: right;">Tasa: </th>
                        <th   id="tasatabla">10</th>
                    </tr>
                    <tr>
                        <th colspan="4" style="text-align: right;">Meses: </th>
                        <th   id="mesestabla">24</th>
                    </tr>
                    <th>Mes</th>
                    <th>Pago Mensual</th>
                    <th>Interés</th>
                    <th>Amortización</th>
                    <th>Saldo</th>
                </tr>
               
            </thead>
            <tbody id="amortizationTable" class="table"></tbody>
                <!-- Rows will be dynamically generated -->
            </tbody>
        </table>
        
        <button type="button" onclick="Exportar('tblamortiza');;"  class="btn btn-link">Exportar datos a Excel</button>
       
         <table id="tblamortiza" style="visibility: hidden;" class="table table-bordered table-striped mt-4">
            <thead class="thead-dark">
                <tr>
                    <tr>
                        <th colspan="5" style="text-align: center; font-size: large;">Tabla Amortización  </th>
                    </tr>
                    <tr>
                        <th colspan="4" style="text-align: right;">Monto: </th>
                        <th  id="montotabla2">=moneda(100000 ) </th>
                    </tr>
                    <tr>
                        <th colspan="4" style="text-align: right;">Tasa: </th>
                        <th   id="tasatabla2">10</th>
                    </tr>
                    <tr>
                        <th colspan="4" style="text-align: right;">Meses: </th>
                        <th   id="mesestabla2">24</th>
                    </tr>
                    <th style="width: 50px;">Mes</th>
                    <th style="width: 150px;">Pago Mensual</th>
                    <th style="width: 150px;">Interés</th>
                    <th style="width: 150px;">Amortización</th>
                    <th style="width: 150px;">Saldo</th>
                </tr>
               
            </thead>
            <tbody id="amortizationOculta"  class="table"></tbody>
                <!-- Rows will be dynamically generated -->
            </tbody>
        </table>
   </div>   
    </div> 
    
    <script>
            $("#amortizationForm").on("submit", function (e) {
                e.preventDefault();

                const principal = parseFloat($("#principal").val());
                const annualInterestRate = parseFloat($("#annualInterestRate").val()) / 100;
                const months = parseInt($("#mesescredito").val());
                const monthlyInterestRate = annualInterestRate / 12;
                const monthlyPayment = (principal * monthlyInterestRate) / (1 - Math.pow(1 + monthlyInterestRate, -months));
                let balance = principal;

                if (monthlyPayment > 0.3 * parseFloat($("#ingresosmensuales").val())) {
                    salariorequerido = (monthlyPayment * 100) / 30;

                    const toast = `
                        <div class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
                            <div class="d-flex">
                                <div class="toast-body">
                                    Datos de referencia, el salario minimo para el monto y plazo del credito seleccionado es de $${salariorequerido.toFixed(2)}.
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>`;
                    $("body").append(toast);
                    const toastElement = $(".toast").toast({ delay: 6000 });
                    toastElement.toast("show");
                    toastElement.on("hidden.bs.toast", function () {
                        $(this).remove();
                    });
                }
$("#montotabla").text(principal.toFixed(2));
$("#tasatabla").text(annualInterestRate.toFixed(3)*100);
$("#mesestabla").text(months);
$("#montotabla2").text("=moneda("+principal.toFixed(2)+")");
$("#tasatabla2").text(annualInterestRate.toFixed(3)*100 );
$("#mesestabla2").text(months);   
                $("#amortizationTable").empty();
                $("#amortizationOculta").empty();

                $("#amortizationTable").append(`
                        <tr>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>${balance.toFixed(2)}</td>
                        </tr>
                    `);
                    $("#amortizationOculta").append(`
                        <tr>
                            <td>0</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>=moneda(${balance.toFixed(2)})</td>
                        </tr>
                    `);
                for (let i = 1; i <= months; i++) {
                    const interest = balance * monthlyInterestRate;
                    const amortization = monthlyPayment - interest;
                    balance -= amortization;

                    $("#amortizationTable").append(`
                        <tr>
                            <td>${i}</td>
                            <td>${monthlyPayment.toFixed(2)}</td>
                            <td>${interest.toFixed(2)}</td>
                            <td>${amortization.toFixed(2)}</td>
                            <td>${balance.toFixed(2)}</td>
                        </tr>
                    `); 
                    $("#amortizationOculta").append(`
                        <tr>
                            <td>=a${i+6}+1</td>
                            <td>=moneda((E$3*(E$4*.01/12))/(1-POTENCIA(1+(E$4*.01/12),-E$5)))</td>
                            <td>=moneda(E${i+6}*(E$4*.01/12))</td>
                            <td>=moneda(B${i+7}-C${i+7})</td>
                            <td>=moneda(e${i+6}-b${i+7}+c${i+7})</td>
                        </tr>
                    `); 
                }
             formatea()
            }
           
        );
        </script> 
     <script>
        $(document).ready(function () {
            const nacionalidades = [
                "Afganistán", "Albania", "Alemania", "Andorra", "Angola", "Antigua y Barbuda", "Arabia Saudita", 
                "Argelia", "Argentina", "Armenia", "Australia", "Austria", "Azerbaiyán", "Bahamas", "Bangladés", 
                "Barbados", "Baréin", "Bélgica", "Belice", "Benín", "Bielorrusia", "Birmania", "Bolivia", 
                "Bosnia y Herzegovina", "Botsuana", "Brasil", "Brunéi", "Bulgaria", "Burkina Faso", "Burundi", 
                "Bután", "Cabo Verde", "Camboya", "Camerún", "Canadá", "Catar", "Chad", "Chile", "China", 
                "Chipre", "Colombia", "Comoras", "Corea del Norte", "Corea del Sur", "Costa de Marfil", 
                "Costa Rica", "Croacia", "Cuba", "Dinamarca", "Dominica", "Ecuador", "Egipto", "El Salvador", 
                "Emiratos Árabes Unidos", "Eritrea", "Eslovaquia", "Eslovenia", "España", "Estados Unidos", 
                "Estonia", "Etiopía", "Filipinas", "Finlandia", "Fiyi", "Francia", "Gabón", "Gambia", "Georgia", 
                "Ghana", "Granada", "Grecia", "Guatemala", "Guinea", "Guinea-Bisáu", "Guinea Ecuatorial", 
                "Guyana", "Haití", "Honduras", "Hungría", "India", "Indonesia", "Irak", "Irán", "Irlanda", 
                "Islandia", "Islas Marshall", "Islas Salomón", "Israel", "Italia", "Jamaica", "Japón", 
                "Jordania", "Kazajistán", "Kenia", "Kirguistán", "Kiribati", "Kuwait", "Laos", "Lesoto", 
                "Letonia", "Líbano", "Liberia", "Libia", "Liechtenstein", "Lituania", "Luxemburgo", "Macedonia", 
                "Madagascar", "Malasia", "Malaui", "Maldivas", "Malí", "Malta", "Marruecos", "Mauricio", 
                "Mauritania", "México", "Micronesia", "Moldavia", "Mónaco", "Mongolia", "Montenegro", 
                "Mozambique", "Namibia", "Nauru", "Nepal", "Nicaragua", "Níger", "Nigeria", "Noruega", 
                "Nueva Zelanda", "Omán", "Países Bajos", "Pakistán", "Palaos", "Panamá", "Papúa Nueva Guinea", 
                "Paraguay", "Perú", "Polonia", "Portugal", "Reino Unido", "República Centroafricana", 
                "República Checa", "República del Congo", "República Democrática del Congo", "República Dominicana", 
                "Ruanda", "Rumanía", "Rusia", "Samoa", "San Cristóbal y Nieves", "San Marino", "San Vicente y las Granadinas", 
                "Santa Lucía", "Santo Tomé y Príncipe", "Senegal", "Serbia", "Seychelles", "Sierra Leona", 
                "Singapur", "Siria", "Somalia", "Sri Lanka", "Suazilandia", "Sudáfrica", "Sudán", "Sudán del Sur", 
                "Suecia", "Suiza", "Surinam", "Tailandia", "Tanzania", "Tayikistán", "Timor Oriental", "Togo", 
                "Tonga", "Trinidad y Tobago", "Túnez", "Turkmenistán", "Turquía", "Tuvalu", "Ucrania", "Uganda", 
                "Uruguay", "Uzbekistán", "Vanuatu", "Vaticano", "Venezuela", "Vietnam", "Yemen", "Yibuti", 
                "Zambia", "Zimbabue"
            ];
            const estadosBuro = [
                "bueno", "malo", "regular"
            ];
            $("#nacionalidad").autocomplete({
                source: function (request, response) {
                    const term = request.term.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const filtered = nacionalidades.filter(nacionalidad => 
                        nacionalidad.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(term)
                    );
                    response(filtered);
                }
            });
            $("#buro").autocomplete({
                source: estadosBuro
            });
        });
    </script>
    <script>
      function Exportar(varnombretabla){
    var uri = 'data:application/vnd.ms-excel;base64,'
    , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
    , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
    , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }

    var table = varnombretabla;
    var name = 'nombre_hoja_calculo';

    if (!table.nodeType) table = document.getElementById(table)
     var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
     window.location.href = uri + base64(format(template, ctx))
}
function formatea() {
        $('#tablahtml td:not(:first-child)').each(function () {
    var item = $(this).text();
    var num = Number(item).toLocaleString('en');    

    if (Number(item) < 0) {
        num = num.replace('-','');
        $(this).addClass('negMoney');
    }else{
        $(this).addClass('enMoney');
    }
    
    $(this).text(num);
});
}


   </script>

 
 <script>
$.ajax({
	url : "https://www.banxico.org.mx/SieAPIRest/service/v1/series/SF43783/datos/oportuno?token=46071f5e2be50df86454d648f1ffb3cfa70928bb13422ff0e906830a5e9d5477",
	jsonp : "callback",
	dataType : "jsonp", //Se utiliza JSONP para realizar la consulta cross-site
	success : function(response) {  //Handler de la respuesta
		var series=response.bmx.series;
		
		//Se carga una tabla con los registros obtenidos
		for (var i in series) {
			  var serie=series[i];
			  var reg=""+serie.titulo+" "+serie.datos[0].fecha+":    "+serie.datos[0].dato+""
			 
              $("#tasareferencia").val(parseFloat(serie.datos[0].dato).toFixed(2));
              $("#lbltasareferencia").text(reg);
              $("#annualInterestRate").val(parseFloat(serie.datos[0].dato).toFixed(2)); 
              actualizatasa()
              
		}
	}
});

 </script>
<script>
    $('#scorecrediticio').on('input', function() {
        var value = $(this).val();
        $('#scorecrediticio2').text('Score: ' + value);
        actualizatasa();
    });
function actualizatasa(){
    var tasareferencia = parseFloat($("#tasareferencia").val());
    var score = parseFloat($("#scorecrediticio").val());
    var edad = parseInt($("#edad").val());

    // Primero ajuste por score
    var tasaAjustada = (tasareferencia - (score - 850) * 0.01);

    // Luego ajuste por edad
    if (edad < 25) {
        tasaAjustada += 0.5;
    } else if (edad > 65) {
        tasaAjustada += 1.0;
    }
    
    if (tasaAjustada < 0) {
        tasaAjustada = 0;
    }

    $("#annualInterestRate").val(tasaAjustada.toFixed(1));
}
</script>
</body> 
</html>
